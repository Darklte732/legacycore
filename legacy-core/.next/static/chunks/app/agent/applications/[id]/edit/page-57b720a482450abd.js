(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[94],{59918:function(e,t,a){Promise.resolve().then(a.bind(a,1760))},1760:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return M}});var l=a(57437),r=a(2265),n=a(16463),i=a(27776),o=a(59772),s=a(39343),c=a(31014);a(6394);var d=a(89733),u=a(71538),m=a(49354),p=a(70402);let h=s.RV,_=r.createContext({}),g=e=>{let{...t}=e;return(0,l.jsx)(_.Provider,{value:{name:t.name},children:(0,l.jsx)(s.Qr,{...t})})},x=()=>{let e=r.useContext(_),t=r.useContext(f),{getFieldState:a,formState:l}=(0,s.Gc)(),n=a(e.name,l);if(!e)throw Error("useFormField should be used within <FormField>");let{id:i}=t;return{id:i,name:e.name,formItemId:`${i}-form-item`,formDescriptionId:`${i}-form-item-description`,formMessageId:`${i}-form-item-message`,...n}},f=r.createContext({}),j=r.forwardRef((e,t)=>{let{className:a,...n}=e,i=r.useId();return(0,l.jsx)(f.Provider,{value:{id:i},children:(0,l.jsx)("div",{ref:t,className:(0,m.cn)("space-y-2",a),...n})})});j.displayName="FormItem";let y=r.forwardRef((e,t)=>{let{className:a,...r}=e,{error:n,formItemId:i}=x();return(0,l.jsx)(p._,{ref:t,className:(0,m.cn)(n&&"text-destructive",a),htmlFor:i,...r})});y.displayName="FormLabel";let v=r.forwardRef((e,t)=>{let{...a}=e,{error:r,formItemId:n,formDescriptionId:i,formMessageId:o}=x();return(0,l.jsx)(u.g7,{ref:t,id:n,"aria-describedby":r?`${i} ${o}`:`${i}`,"aria-invalid":!!r,...a})});v.displayName="FormControl";let b=r.forwardRef((e,t)=>{let{className:a,...r}=e,{formDescriptionId:n}=x();return(0,l.jsx)("p",{ref:t,id:n,className:(0,m.cn)("text-sm text-muted-foreground",a),...r})});b.displayName="FormDescription";let w=r.forwardRef((e,t)=>{let{className:a,children:r,...n}=e,{error:i,formMessageId:o}=x(),s=i?String(i?.message):r;return s?(0,l.jsx)("p",{ref:t,id:o,className:(0,m.cn)("text-sm font-medium text-destructive",a),...n,children:s}):null});w.displayName="FormMessage";var N=a(77209),P=a(44541),C=a(4919),k=a(2128),A=a(82157),S=a(6683),$=a(48185),I=a(54184),E=a(73657),D=a(84379);let z=o.z.object({proposed_insured:o.z.string().min(1,"Client name is required"),client_email:o.z.string().email("Invalid email address").optional().or(o.z.literal("")),client_phone_number:o.z.string().min(10,"Valid phone number required"),client_state:o.z.string().min(1,"State is required"),month:o.z.string().optional(),policy_submit_date:o.z.string().optional(),policy_number:o.z.string().optional(),carrier:o.z.string().min(1,"Carrier is required"),product:o.z.string().min(1,"Policy type is required"),monthly_premium:o.z.union([o.z.string(),o.z.number()]),ap:o.z.union([o.z.string(),o.z.number()]).optional(),status:o.z.string().min(1,"Status is required").refine(e=>e.trim().length>0,{message:"Status cannot be empty"}),policy_health:o.z.string().optional(),paid_status:o.z.string().optional(),closed_by_agent:o.z.string().optional(),point_of_sale:o.z.string().optional(),pms_form_filled_out:o.z.boolean().optional(),split_with:o.z.string().optional(),split_percentage:o.z.union([o.z.string(),o.z.number()]).optional(),effective_policy_date:o.z.string().optional(),effective_policy_status:o.z.string().optional(),notes:o.z.string().optional(),notes_for_pay:o.z.string().optional(),paid_split:o.z.string().optional(),commission_status:o.z.string().optional(),commission_paid_date:o.z.string().optional(),policy_payment_cycle:o.z.string().optional(),commission_amount:o.z.union([o.z.string(),o.z.number()]).optional()}).catchall(o.z.any());function M(){let{id:e}=(0,n.useParams)(),t=(0,n.useRouter)(),a=(0,A.e)(),{role:o,loading:u}=(0,S.q)(),[m,p]=(0,r.useState)([]),[_,x]=(0,r.useState)(!0),[f,M]=(0,r.useState)(!1),[U,F]=(0,r.useState)(null),Y=(0,s.cI)({resolver:(0,c.F)(z),defaultValues:{proposed_insured:"",client_email:"",client_phone_number:"",client_state:"",month:"",policy_submit_date:"",policy_number:"",carrier:"",product:"",monthly_premium:"",ap:"",status:"Pending",policy_health:"",paid_status:"",closed_by_agent:"",point_of_sale:"",pms_form_filled_out:!1,split_with:"",split_percentage:"40",effective_policy_date:"",effective_policy_status:"",notes:"",notes_for_pay:"",paid_split:"",commission_status:"",commission_paid_date:"",policy_payment_cycle:"",commission_amount:""}}),V=e=>{if(!e)return"";try{if(/^\d{4}-\d{2}-\d{2}/.test(e))return e.split("T")[0];let t=new Date(e);if((0,I.J)(t))return(0,E.WU)(t,"yyyy-MM-dd");return console.warn("Invalid date format:",e),""}catch(e){return console.error("Error formatting date:",e),""}};(0,r.useEffect)(()=>{async function t(){x(!0);let t=Array.isArray(e)?e[0]:e;console.log("Fetching application with ID:",t);try{let{data:e,error:l}=await a.from("carriers").select("id, name");if(l){console.error("Error fetching carriers:",l),i.Am.error("Error loading carriers"),x(!1);return}console.log("Carriers loaded:",e),p(e||[]);let{data:r,error:n}=await a.from("agent_applications").select("*").eq("id",t).single();if(n){console.error("Error fetching application data:",n),i.Am.error("Error loading application data"),x(!1);return}if(!r){console.error("No application data found for ID:",t),i.Am.error("Application data not found"),x(!1);return}console.log("Application data loaded:",JSON.stringify(r,null,2)),F(r);let o={proposed_insured:r.proposed_insured||"",client_email:r.client_email||"",client_phone_number:r.client_phone_number||"",client_state:r.client_state||"",month:r.month||"",policy_submit_date:V(r.policy_submit_date),policy_number:r.policy_number||"",carrier:r.carrier||"",product:r.product||"",monthly_premium:r.monthly_premium?.toString()||"",ap:r.ap?.toString()||"",status:r.status||"Pending",policy_health:r.policy_health||"",paid_status:r.paid_status||"",closed_by_agent:r.closed_by_agent||"",point_of_sale:r.point_of_sale||"",pms_form_filled_out:!!r.pms_form_filled_out,split_with:r.split_with||"",split_percentage:r.split_percentage?.toString()||"40",effective_policy_date:V(r.effective_policy_date),effective_policy_status:r.effective_policy_status||"",notes:r.notes||"",notes_for_pay:r.notes_for_pay||"",paid_split:r.paid_split||"",commission_status:r.commission_status||"Pending",commission_paid_date:V(r.commission_paid_date),policy_payment_cycle:r.policy_payment_cycle||"Initial",commission_amount:r.commission_amount?.toString()||""};console.log("Setting form values with:",JSON.stringify(o,null,2)),Y.reset(o),console.log("Form values after reset:",Y.getValues()),x(!1)}catch(e){console.error("Unexpected error fetching application:",e),i.Am.error("Failed to load application"),x(!1)}}e?t():(console.error("No application ID provided"),i.Am.error("No application ID provided"),x(!1))},[e,a,Y]);let L=e=>null==e?0:"string"==typeof e?parseFloat(e.replace(/[^0-9.-]+/g,""))||0:"number"==typeof e?e:0;async function R(l){console.log("onSubmit called with values:",l),M(!0);try{if(!l.proposed_insured?.trim()){i.Am.error("Client name is required"),M(!1);return}if(!l.client_phone_number?.trim()){i.Am.error("Client phone number is required"),M(!1);return}if(!l.carrier?.trim()){i.Am.error("Carrier is required"),M(!1);return}if(!l.product?.trim()){i.Am.error("Policy type is required"),M(!1);return}let r=L(l.monthly_premium),n=12*r;console.log(`Calculating final AP for submission: $${r} monthly \xd7 12 = $${n} annual`);let o=l.split_percentage?L(l.split_percentage):40,s=(100-o)/100,c=9*r*s;console.log(`Calculating commission: $${r} monthly \xd7 9 \xd7 ${s} = $${c}`);let d={...l,monthly_premium:r,ap:n,commission_amount:l.commission_amount?L(l.commission_amount):c,split_percentage:o,client_email:l.client_email||null};console.log("Submitting data:",d);let{data:u,error:m}=await a.from("agent_applications").update(d).eq("id",Array.isArray(e)?e[0]:e).select();if(m){console.error("Update error:",m),i.Am.error("Failed to update application");return}if("Paid"===l.paid_status)try{await a.from("agent_applications").update({month_1:"PAID"}).eq("id",Array.isArray(e)?e[0]:e);let t=Array.isArray(e)?e[0]:e,r=l.effective_policy_date||new Date().toISOString(),{error:n}=await a.from("application_payments").upsert({application_id:t,month_number:1,payment_status:"PAID",payment_date:r,updated_at:new Date().toISOString()},{onConflict:"application_id,month_number"});n&&console.error("Error updating payment record:",n)}catch(e){console.error("Error updating payment status:",e)}i.Am.success("Application updated successfully"),console.log("Update successful:",u),t.push("/agent/applications")}catch(e){console.error("Direct update error:",e),i.Am.error("An error occurred while updating the application")}finally{M(!1)}}let T=["Term Life","Whole Life","Universal Life","Final Expense","Indexed Universal Life","Medicare Supplement","Medicare Advantage","Annuity","Other"],Q=[{value:"Pending",label:"Pending"},{value:"Approved",label:"Approved"},{value:"In Progress",label:"In Progress"},{value:"UW",label:"UW"},{value:"Declined",label:"Declined"},{value:"Cancelled",label:"Cancelled"},{value:"Cancellation in Progress",label:"Cancellation in Progress"},{value:"Live",label:"Live"},{value:"1st Month Paid",label:"1st Month Paid"},{value:"Hold",label:"Hold"},{value:"Review",label:"Review"},{value:"Postponed",label:"Postponed"}],O=[{value:"Active",label:"Active"},{value:"Pending First Payment",label:"Pending First Payment"},{value:"Payment Issues",label:"Payment Issues"},{value:"Needs Attention",label:"Needs Attention"},{value:"Cancelled",label:"Cancelled"}],W=[{value:"Paid",label:"Paid"},{value:"Unpaid",label:"Unpaid"},{value:"Partial",label:"Partial"},{value:"Pending",label:"Pending"}],q=[{value:"Pending",label:"Pending"},{value:"Paid",label:"Paid"},{value:"Not Applicable",label:"Not Applicable"},{value:"Partial",label:"Partial"}],B=[{value:"Initial",label:"Initial"},{value:"Monthly",label:"Monthly"},{value:"Quarterly",label:"Quarterly"},{value:"Semi-Annual",label:"Semi-Annual"},{value:"Annual",label:"Annual"}],H=["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"],G=async()=>{try{x(!0),console.log("Refetching application data after update");let t=Array.isArray(e)?e[0]:e,{data:l,error:r}=await a.from("agent_applications").select("*").eq("id",t).single();if(r){console.error("Error refetching application data:",r),i.Am.error("Failed to refresh application data"),x(!1);return}if(l){console.log("Refreshed application data:",l),F(l);let e={proposed_insured:l.proposed_insured||"",client_email:l.client_email||"",client_phone_number:l.client_phone_number||"",client_state:l.client_state||"",month:l.month||"",policy_submit_date:V(l.policy_submit_date),policy_number:l.policy_number||"",carrier:l.carrier||"",product:l.product||"",monthly_premium:l.monthly_premium?.toString()||"",ap:l.ap?.toString()||"",status:l.status||"Pending",policy_health:l.policy_health||"",paid_status:l.paid_status||"",closed_by_agent:l.closed_by_agent||"",point_of_sale:l.point_of_sale||"",pms_form_filled_out:!!l.pms_form_filled_out,split_with:l.split_with||"",split_percentage:l.split_percentage?.toString()||"20",effective_policy_date:V(l.effective_policy_date),effective_policy_status:l.effective_policy_status||"",notes:l.notes||"",notes_for_pay:l.notes_for_pay||"",paid_split:l.paid_split||"",commission_status:l.commission_status||"Pending",commission_paid_date:V(l.commission_paid_date),policy_payment_cycle:l.policy_payment_cycle||"Initial",commission_amount:l.commission_amount?.toString()||""};Y.reset(e)}x(!1)}catch(e){console.error("Error in refetchData:",e),i.Am.error("Failed to refresh data"),x(!1)}},J=async t=>{try{let a=(0,A.e)(),l=!1,r=0;for(;!l&&r<3;){r++,console.log(`Updating policy health to "${t}" (attempt ${r})`);let{data:n,error:i}=await a.rpc("force_update_policy_health",{p_application_id:Array.isArray(e)?e[0]:e,p_policy_health:t});if(i){if(console.error(`RPC error on attempt ${r}:`,i),3===r)throw i;await new Promise(e=>setTimeout(e,300*r));continue}l=!0}if(!l)throw Error("Failed to update policy health after multiple attempts");return Y.setValue("policy_health",t),U&&F({...U,policy_health:t}),i.Am.success(`Policy health updated to ${t}`),await G(),!0}catch(e){return console.error("Error updating policy health:",e),i.Am.error("Failed to update policy health: "+(e.message||"Unknown error")),!1}},Z=[{value:"Active",label:"Active"},{value:"Inactive",label:"Inactive"},{value:"Pending",label:"Pending"},{value:"Cancelled",label:"Cancelled"},{value:"Expired",label:"Expired"}];return(0,l.jsxs)("div",{className:"edit-application-form",children:[(0,l.jsxs)(d.z,{variant:"ghost",onClick:()=>t.back(),className:"back-button",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-arrow-left",children:[(0,l.jsx)("path",{d:"m12 19-7-7 7-7"}),(0,l.jsx)("path",{d:"M19 12H5"})]}),"Back"]}),(0,l.jsx)("h1",{className:"page-title animate-in",children:"Edit Application"}),(0,l.jsx)("p",{className:"page-subtitle",children:"Update the application information"}),(0,l.jsx)(h,{...Y,children:(0,l.jsxs)("form",{onSubmit:Y.handleSubmit(R),className:"space-y-8",children:[(0,l.jsxs)($.Zb,{className:"card animate-in",children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),(0,l.jsx)("circle",{cx:"12",cy:"7",r:"4"})]}),"Client Information"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsx)(g,{control:Y.control,name:"proposed_insured",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"form-field",children:[(0,l.jsx)(y,{children:"Client Name*"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Full Name",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"client_email",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"form-field",children:[(0,l.jsx)(y,{children:"Client Email"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{type:"email",placeholder:"Email Address",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"client_phone_number",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"form-field",children:[(0,l.jsx)(y,{children:"Client Phone*"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Phone Number",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"client_state",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"form-field",children:[(0,l.jsx)(y,{children:"State*"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select state"})})}),(0,l.jsx)(k.Bw,{children:H.map(e=>(0,l.jsx)(k.Ql,{value:e,children:e},e))})]}),(0,l.jsx)(w,{})]})}})]})})]}),(0,l.jsxs)($.Zb,{className:"card animate-in",style:{animationDelay:"50ms"},children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),(0,l.jsx)("path",{d:"M14 2v6h6"}),(0,l.jsx)("path",{d:"M16 13H8"}),(0,l.jsx)("path",{d:"M16 17H8"}),(0,l.jsx)("path",{d:"M10 9H8"})]}),"Policy Information"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsx)(g,{control:Y.control,name:"month",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"form-field",children:[(0,l.jsx)(y,{children:"Month"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Month (e.g., Jan 2023)",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"policy_submit_date",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"form-field",children:[(0,l.jsx)(y,{children:"Policy Submit Date"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{type:"date",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"policy_number",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Policy Number"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Policy Number",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"carrier",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Carrier*"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select carrier"})})}),(0,l.jsx)(k.Bw,{children:m.map(e=>(0,l.jsx)(k.Ql,{value:e.name,children:e.name},e.id))})]}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"product",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Policy Type*"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select policy type"})})}),(0,l.jsx)(k.Bw,{children:T.map(e=>(0,l.jsx)(k.Ql,{value:e,children:e},e))})]}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"monthly_premium",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Monthly Premium"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"$0.00",value:t.value||"",onChange:e=>{let a=e.target.value.replace(/[^0-9.-]/g,"");t.onChange(a);let l=parseFloat(a)||0,r=12*l;console.log(`Monthly premium changed to: $${l}, calculating AP: $${l} \xd7 12 = $${r}`),Y.setValue("ap",r.toString());let n=(100-(Y.getValues("split_percentage")||40))/100,i=9*l*n;Y.setValue("commission_amount",i.toString()),console.log(`Commission calculated as: $${l} \xd7 9 \xd7 ${n} = $${i}`)},onBlur:()=>{let e=t.value;if(e){let t=parseFloat(e.toString())||0;Y.setValue("ap",(12*t).toString())}},className:"bg-white focus:border-blue-500"})}),(0,l.jsx)(b,{children:"Enter monthly premium amount - AP will auto-calculate"}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"ap",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsxs)(y,{className:"flex items-center",children:["Annual Premium (12-month)",(0,l.jsx)("span",{className:"ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full",children:"auto-calculated"})]}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"$0.00",...t,className:"bg-gray-50 border-gray-300"})}),(0,l.jsx)(b,{className:"text-blue-600",children:"Calculated as monthly premium \xd7 12"}),(0,l.jsx)(w,{})]})}})]})})]}),(0,l.jsxs)($.Zb,{className:"card animate-in",style:{animationDelay:"100ms"},children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("path",{d:"M12 20h9"}),(0,l.jsx)("path",{d:"M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"})]}),"Status Information"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsx)(g,{control:Y.control,name:"status",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Status*"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select status"})})}),(0,l.jsx)(k.Bw,{children:Q.map(e=>(0,l.jsx)(k.Ql,{value:e.value,children:e.label},e.value))})]}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"policy_health",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Policy Health"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:e=>{t.onChange(e),J(e)},children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select policy health"})})}),(0,l.jsx)(k.Bw,{children:O.map(e=>(0,l.jsx)(k.Ql,{value:e.value,children:e.label},e.value))})]}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"paid_status",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Paid Status"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select paid status"})})}),(0,l.jsx)(k.Bw,{children:W.map(e=>(0,l.jsx)(k.Ql,{value:e.value,children:e.label},e.value))})]}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"closed_by_agent",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Closed By Agent"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Agent Name",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"effective_policy_date",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Effective Policy Date"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{type:"date",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"effective_policy_status",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Effective Policy Status"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select status"})})}),(0,l.jsx)(k.Bw,{children:Z.map(e=>(0,l.jsx)(k.Ql,{value:e.value,children:e.label},e.value))})]}),(0,l.jsx)(w,{})]})}})]})})]}),(0,l.jsxs)($.Zb,{className:"card animate-in",style:{animationDelay:"150ms"},children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("rect",{x:"1",y:"4",width:"22",height:"16",rx:"2",ry:"2"}),(0,l.jsx)("line",{x1:"1",y1:"10",x2:"23",y2:"10"})]}),"Payment History"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsx)(D.Zl,{}),U&&(0,l.jsx)(D.e0,{application:U,onPaymentUpdated:G}),(0,l.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:"Click on any payment indicator to update its status. Changes will be reflected immediately and may update the Policy Health status automatically."})]})})]}),(0,l.jsxs)($.Zb,{className:"card animate-in",style:{animationDelay:"200ms"},children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,l.jsx)("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),(0,l.jsx)("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),"Additional Information"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsx)(g,{control:Y.control,name:"point_of_sale",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Point of Sale"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Point of Sale",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"split_with",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Split With"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Agent Name",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"split_percentage",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Split Percentage"}),(0,l.jsxs)(k.Ph,{value:t.value?.toString()||"20",onValueChange:e=>{t.onChange(parseInt(e));let a=parseFloat(Y.getValues("monthly_premium"))||0,l=(100-parseInt(e))/100,r=9*a*l;Y.setValue("commission_amount",r.toString()),console.log(`Commission recalculated: $${a} \xd7 9 \xd7 ${l} = $${r}`)},children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select split percentage"})})}),(0,l.jsxs)(k.Bw,{children:[(0,l.jsx)(k.Ql,{value:"5",children:"5% (You keep 95%)"}),(0,l.jsx)(k.Ql,{value:"10",children:"10% (You keep 90%)"}),(0,l.jsx)(k.Ql,{value:"15",children:"15% (You keep 85%)"}),(0,l.jsx)(k.Ql,{value:"20",children:"20% (You keep 80%)"}),(0,l.jsx)(k.Ql,{value:"25",children:"25% (You keep 75%)"}),(0,l.jsx)(k.Ql,{value:"30",children:"30% (You keep 70%)"}),(0,l.jsx)(k.Ql,{value:"35",children:"35% (You keep 65%)"}),(0,l.jsx)(k.Ql,{value:"40",children:"40% (You keep 60%)"}),(0,l.jsx)(k.Ql,{value:"45",children:"45% (You keep 55%)"}),(0,l.jsx)(k.Ql,{value:"50",children:"50% (You keep 50%)"}),(0,l.jsx)(k.Ql,{value:"55",children:"55% (You keep 45%)"}),(0,l.jsx)(k.Ql,{value:"60",children:"60% (You keep 40%)"}),(0,l.jsx)(k.Ql,{value:"65",children:"65% (You keep 35%)"}),(0,l.jsx)(k.Ql,{value:"70",children:"70% (You keep 30%)"}),(0,l.jsx)(k.Ql,{value:"75",children:"75% (You keep 25%)"}),(0,l.jsx)(k.Ql,{value:"80",children:"80% (You keep 20%)"}),(0,l.jsx)(k.Ql,{value:"85",children:"85% (You keep 15%)"}),(0,l.jsx)(k.Ql,{value:"90",children:"90% (You keep 10%)"}),(0,l.jsx)(k.Ql,{value:"95",children:"95% (You keep 5%)"})]})]}),(0,l.jsx)(b,{children:"Percentage that goes to the split agent. The rest goes to you."}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"paid_split",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Paid Split"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"Split Details",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"pms_form_filled_out",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{className:"flex flex-row items-center space-x-3 space-y-0 rounded-md border p-4",children:[(0,l.jsx)(v,{children:(0,l.jsx)(P.X,{checked:t.value,onCheckedChange:t.onChange})}),(0,l.jsx)("div",{className:"space-y-1 leading-none",children:(0,l.jsx)(y,{children:"PMS Form Filled Out"})})]})}})]})})]}),(0,l.jsxs)($.Zb,{className:"card animate-in",style:{animationDelay:"250ms"},children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("line",{x1:"12",y1:"1",x2:"12",y2:"23"}),(0,l.jsx)("path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})]}),"Commission Information"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"form-grid form-grid-2",children:[(0,l.jsx)(g,{control:Y.control,name:"commission_status",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Commission Status"}),(0,l.jsxs)(k.Ph,{value:t.value||"Pending",onValueChange:e=>{console.log("Commission status changed to:",e),t.onChange(e)},children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select commission status"})})}),(0,l.jsx)(k.Bw,{children:q.map(e=>(0,l.jsx)(k.Ql,{value:e.value,children:e.label},e.value))})]}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"commission_paid_date",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Commission Paid Date"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{type:"date",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"commission_amount",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Commission Amount"}),(0,l.jsx)(v,{children:(0,l.jsx)(N.I,{placeholder:"$0.00",value:t.value||"0",onChange:e=>{let a=e.target.value.replace(/[^\d.-]/g,"");t.onChange(a),console.log("Commission amount changed to:",a)}})}),(0,l.jsx)(b,{children:"Auto-calculated as: Monthly Premium \xd7 9 \xd7 (Your Split Percentage)"}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"policy_payment_cycle",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Payment Cycle"}),(0,l.jsxs)(k.Ph,{value:t.value,onValueChange:t.onChange,children:[(0,l.jsx)(v,{children:(0,l.jsx)(k.i4,{children:(0,l.jsx)(k.ki,{placeholder:"Select payment cycle"})})}),(0,l.jsx)(k.Bw,{children:B.map(e=>(0,l.jsx)(k.Ql,{value:e.value,children:e.label},e.value))})]}),(0,l.jsx)(w,{})]})}})]})})]}),(0,l.jsxs)($.Zb,{className:"card animate-in",style:{animationDelay:"300ms"},children:[(0,l.jsx)($.Ol,{className:"card-header",children:(0,l.jsxs)($.ll,{className:"card-title",children:[(0,l.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,l.jsx)("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),(0,l.jsx)("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),"Notes"]})}),(0,l.jsx)($.aY,{className:"card-content",children:(0,l.jsxs)("div",{className:"grid grid-cols-1 gap-4",children:[(0,l.jsx)(g,{control:Y.control,name:"notes",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Notes"}),(0,l.jsx)(v,{children:(0,l.jsx)(C.g,{placeholder:"General notes about this application",className:"min-h-[100px]",...t})}),(0,l.jsx)(w,{})]})}}),(0,l.jsx)(g,{control:Y.control,name:"notes_for_pay",render:e=>{let{field:t}=e;return(0,l.jsxs)(j,{children:[(0,l.jsx)(y,{children:"Notes for Pay"}),(0,l.jsx)(v,{children:(0,l.jsx)(C.g,{placeholder:"Notes related to payment",className:"min-h-[100px]",...t})}),(0,l.jsx)(w,{})]})}})]})})]}),(0,l.jsxs)("div",{className:"form-actions",children:[(0,l.jsx)(d.z,{type:"button",variant:"outline",onClick:()=>t.back(),disabled:f,className:"outline",children:"Cancel"}),(0,l.jsx)(d.z,{type:"button",disabled:f,className:"primary",onClick:async()=>{try{console.log("Direct database update initiated"),M(!0);let l=Array.isArray(e)?e[0]:e;console.log("Application ID for direct update:",l);let r=Y.getValues();console.log("Form values for direct update:",r);let n=e=>{if(null==e||""===e)return null;let t="string"==typeof e?parseFloat(e.replace(/[^\d.-]/g,"")):e;return isNaN(t)?null:t};if(r.policy_health&&r.policy_health!==U?.policy_health){console.log(`Policy health changing from ${U?.policy_health} to ${r.policy_health}`);try{let e=await a.rpc("force_update_policy_health",{p_application_id:l,p_policy_health:r.policy_health});e.error?(console.error("Error updating policy health with RPC:",e.error),i.Am.error(`Failed to update policy health: ${e.error.message}`)):(console.log("Policy health updated successfully with RPC"),U&&F({...U,policy_health:r.policy_health}))}catch(e){console.error("Exception updating policy health:",e)}}let o=n(r.monthly_premium)||0,s=12*o;console.log(`Direct update AP calculation: $${o} \xd7 12 = $${s}`);let c=n(r.split_percentage)||40,d=c/100,u=9*o*d;console.log(`Commission calculation: $${o} \xd7 9 \xd7 ${d} = $${u}`);let m=["Pending","Partial","Paid","Not Applicable"];if(r.commission_status&&!m.includes(r.commission_status)){i.Am.error(`Invalid commission status: ${r.commission_status}. Must be one of: ${m.join(", ")}`),M(!1);return}let p={proposed_insured:r.proposed_insured?.trim(),client_email:r.client_email?.trim()||null,client_phone_number:r.client_phone_number?.trim(),client_state:r.client_state,month:r.month?.trim(),policy_submit_date:r.policy_submit_date||null,policy_number:r.policy_number?.trim()||null,carrier:r.carrier?.trim(),product:r.product?.trim(),monthly_premium:n(r.monthly_premium),ap:s,status:r.status?.trim(),policy_health:r.policy_health?.trim()||null,paid_status:r.paid_status?.trim()||null,closed_by_agent:r.closed_by_agent?.trim()||null,point_of_sale:r.point_of_sale?.trim()||null,pms_form_filled_out:!!r.pms_form_filled_out,split_with:r.split_with?.trim()||null,split_percentage:c,effective_policy_date:r.effective_policy_date||null,effective_policy_status:r.effective_policy_status?.trim()||null,notes:r.notes?.trim()||null,notes_for_pay:r.notes_for_pay?.trim()||null,paid_split:r.paid_split?.trim()||null,commission_status:r.commission_status||"Pending",commission_paid_date:r.commission_paid_date||null,policy_payment_cycle:r.policy_payment_cycle||"Initial",commission_amount:r.commission_amount?n(r.commission_amount):u,month_1:U?.month_1||null,month_2:U?.month_2||null,month_3:U?.month_3||null,month_4:U?.month_4||null,month_5:U?.month_5||null,month_6:U?.month_6||null,month_7:U?.month_7||null,month_8:U?.month_8||null,month_9:U?.month_9||null,month_10:U?.month_10||null,month_11:U?.month_11||null,month_12:U?.month_12||null,updated_at:new Date().toISOString()},{data:{session:h}}=await a.auth.getSession();h?.user?.id&&(p.agent_id=h.user.id),console.log("Complete update data:",p);let _=!1,g=0;for(;!_&&g<3;){g++;try{let{data:e,error:t}=await a.from("agent_applications").update(p).eq("id",l).select();if(t){if(console.error(`Direct update error (attempt ${g}):`,t),"23514"===t.code&&t.message.includes("commission_status_check")?i.Am.error("Invalid Commission Status: Please select from Pending, Partial, Paid, or Not Applicable"):i.Am.error(`Failed to update: ${t.message}`),g<3){await new Promise(e=>setTimeout(e,500*g));continue}M(!1);return}if(e&&0!==e.length)console.log(`Direct update successful on attempt ${g}! Updated data:`,e),_=!0;else{console.error("Update successful but no data returned - update may not have been applied");let{data:e}=await a.from("agent_applications").select("updated_at").eq("id",l).single();if(e&&new Date(e.updated_at)>new Date(U?.updated_at||0))console.log("Update verified through timestamp check"),_=!0;else{if(i.Am.error("Update may not have been saved. Please check and try again."),g<3){await new Promise(e=>setTimeout(e,500*g));continue}M(!1);return}}}catch(e){if(console.error(`Update error (attempt ${g}):`,e),g>=3){i.Am.error("Failed after multiple attempts. Please try again later."),M(!1);return}await new Promise(e=>setTimeout(e,500*g))}}await new Promise(e=>setTimeout(e,1e3));try{let{data:e,error:t}=await a.from("agent_applications").select("*").eq("id",l).single();t?console.error("Verification error:",t):(console.log("Verification data:",e),e.policy_health!==p.policy_health||e.status!==p.status||e.paid_status!==p.paid_status?(console.warn("Verification shows different values than what was submitted!"),console.warn("Expected vs actual:",{policy_health:{expected:p.policy_health,actual:e.policy_health},status:{expected:p.status,actual:e.status},paid_status:{expected:p.paid_status,actual:e.paid_status}}),e.policy_health!==p.policy_health&&await a.rpc("force_update_policy_health",{p_application_id:l,p_policy_health:p.policy_health})):console.log("Verification successful - changes were applied correctly"))}catch(e){console.error("Error verifying update:",e)}i.Am.success("Application updated successfully"),await G(),M(!1),t.push("/agent/applications")}catch(e){console.error("Error saving application:",e),i.Am.error("An error occurred while saving the application"),M(!1)}},children:f?(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"loading-spinner"}),"Saving..."]}):"Save Changes"})]})]})})]})}},4919:function(e,t,a){"use strict";a.d(t,{g:function(){return i}});var l=a(57437),r=a(2265),n=a(49354);let i=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,l.jsx)("textarea",{className:(0,n.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:t,...r})});i.displayName="Textarea"},6683:function(e,t,a){"use strict";a.d(t,{q:function(){return n}});var l=a(2265),r=a(82157);let n=()=>{let[e,t]=(0,l.useState)(null),[a,n]=(0,l.useState)(!0),[i,o]=(0,l.useState)(!1),[s,c]=(0,l.useState)(0),d=(0,r.e)(),u=()=>{console.log("Clearing all role-related cookies to prevent conflicts"),document.cookie="force_manager_view=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="test_role=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="admin_redirected=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="handling_redirect=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT"},m=async(e,t)=>{console.log("⚠️ SECURITY: Forcing removal of admin role for unauthorized user"),u();try{await d.from("profiles").update({role:"agent"}).eq("id",e),console.log("Updated database role from admin to agent");let{error:t}=await d.auth.updateUser({data:{role:"agent"}});t&&console.error("Error updating user metadata:",t),setTimeout(()=>window.location.href="/agent/dashboard",100)}catch(e){console.error("Error clearing admin role:",e)}},p=async(e,t)=>{try{console.log(`Synchronizing user metadata role to match database: ${t}`);let{error:e}=await d.auth.updateUser({data:{role:t}});e&&console.error("Error updating user metadata:",e)}catch(e){console.error("Error synchronizing roles:",e)}},h=e=>{let t=Date.now();if(i||t-s<2e3){console.log("Preventing potential redirect loop");return}o(!0),c(t),document.cookie="handling_redirect=true; path=/; max-age=5",setTimeout(()=>{console.log(`Redirecting to /${e}/dashboard`),window.location.href=`/${e}/dashboard`,o(!1)},100)};return(0,l.useEffect)(()=>{let e=async()=>{try{let e=window.location.pathname,r=e.startsWith("/admin"),i=e.startsWith("/manager"),o=e.startsWith("/agent");if(r||i||o){let e=document.cookie.split("; ").find(e=>e.startsWith("test_role="))?.split("=")[1];o&&e&&"agent"!==e&&(console.log(`Path is /agent but test_role cookie is ${e}, clearing to prevent sidebar mismatch`),u()),i&&e&&"manager"!==e&&(console.log(`Path is /manager but test_role cookie is ${e}, clearing to prevent sidebar mismatch`),u()),r&&e&&"admin"!==e&&(console.log(`Path is /admin but test_role cookie is ${e}, clearing to prevent sidebar mismatch`),u())}if(document.cookie.includes("handling_redirect=true")){console.log("Skipping role check - redirect in progress"),n(!1);return}let s=document.cookie.split("; ").find(e=>e.startsWith("force_manager_view="))?.split("=")[1],c=document.cookie.split("; ").find(e=>e.startsWith("test_role="))?.split("=")[1],{data:{session:_}}=await d.auth.getSession();if(!_){t(null),n(!1);return}let g=["980ebab6-9e1a-4c53-876a-978c8c640f7e","adbdb861-5ce8-4b5c-af50-7deb93a687c1"];if(_.user.user_metadata?.role==="admin"&&!g.includes(_.user.id)){await m(_.user.id,_.user.email||""),t("agent"),n(!1);return}if("true"===s){console.log("⚠️ FORCED MANAGER VIEW: Using manager role from force_manager_view cookie"),await l(_.user.id,_.user.email,"manager"),t("manager"),n(!1);return}if(o){console.log("\uD83D\uDC49 On agent path, ensuring agent role and sidebar"),c&&u(),t("agent"),n(!1);return}if(i){console.log("\uD83D\uDC49 On manager path, ensuring manager role and sidebar"),c&&u(),t("manager"),n(!1);return}if(r){if(g.includes(_.user.id)){console.log("\uD83D\uDC49 On admin path with valid admin ID, ensuring admin role and sidebar"),c&&u(),t("admin"),n(!1);return}console.log("⚠️ SECURITY: Non-admin attempting to access admin path"),u(),h("agent");return}if("56e8e969-76fd-4d69-a8ca-3e315487c2c4"===_.user.id){console.log("⚠️ APPLYING ROLE OVERRIDE: Setting role to manager for santosUser"),await l(_.user.id,_.user.email,"manager"),t("manager"),n(!1);return}if(c&&["admin","manager","agent"].includes(c)){if("admin"===c&&!g.includes(_.user.id)){console.log("⚠️ SECURITY: Unauthorized admin access attempt via cookie. Defaulting to agent role."),document.cookie="test_role=agent; path=/; max-age=86400",t("agent"),n(!1);return}console.log(`⚠️ DEVELOPMENT MODE: Using ${c} role from test_role cookie`),t(c),n(!1);return}let{data:x}=await d.from("profiles").select("role").eq("id",_.user.id).single();if(x&&x.role){if(console.log(`Using role from database profile: ${x.role}`),"admin"===x.role&&!g.includes(_.user.id)){console.warn("⚠️ SECURITY: Unauthorized admin role in database. Correcting to agent."),await m(_.user.id,_.user.email||""),t("agent"),n(!1);return}if(_.user.user_metadata?.role&&_.user.user_metadata.role!==x.role&&(console.warn(`⚠️ Role mismatch: metadata (${_.user.user_metadata.role}) vs database (${x.role}). Using database role.`),await p(_.user.id,x.role)),t(x.role),e.startsWith("/admin")&&"admin"!==x.role){console.log(`⚠️ Path mismatch: User with role ${x.role} on admin path. Redirecting...`),n(!1),h(x.role);return}if(e.startsWith("/manager")&&"manager"!==x.role){console.log(`⚠️ Path mismatch: User with role ${x.role} on manager path. Redirecting...`),n(!1),h(x.role);return}if(e.startsWith("/agent")&&"agent"!==x.role){console.log(`⚠️ Path mismatch: User with role ${x.role} on agent path. Redirecting...`),n(!1),h(x.role);return}n(!1);return}if(_.user.user_metadata?.role&&["admin","manager","agent"].includes(_.user.user_metadata.role)){if("admin"===_.user.user_metadata.role&&!g.includes(_.user.id)){console.warn("⚠️ SECURITY: Unauthorized admin role in metadata. Correcting to agent."),await m(_.user.id,_.user.email||""),t("agent"),n(!1);return}console.log(`Using role from user metadata (no profile): ${_.user.user_metadata.role}`),await a(_.user.id,_.user.email,_.user.user_metadata.role),t(_.user.user_metadata.role)}else console.log("No role found. Defaulting to agent role."),await a(_.user.id,_.user.email||"","agent"),t("agent");n(!1)}catch(e){console.error("Error determining user role:",e),t(null),n(!1)}},a=async(e,t,a)=>{try{let{error:l}=await d.from("profiles").insert({id:e,email:t,role:a}).select();l&&console.error("Error creating user profile:",l)}catch(e){console.error("Error in profile creation:",e)}},l=async(e,t,l)=>{try{let{data:r}=await d.from("profiles").select("role").eq("id",e).single();r?r.role!==l&&(await d.from("profiles").update({role:l}).eq("id",e),console.log(`Updated profile role from ${r.role} to ${l}`)):(await a(e,t,l),console.log(`Created new profile with role ${l}`))}catch(e){console.error("Error ensuring profile has role:",e)}};e();let{data:{subscription:r}}=d.auth.onAuthStateChange((a,l)=>{if(!l){t(null);return}e()});return()=>{r.unsubscribe()}},[d,i,s]),{role:e,loading:a,isAdmin:"admin"===e,isManager:"manager"===e,isAgent:"agent"===e}}},6394:function(){}},function(e){e.O(0,[5730,8753,4392,4868,9776,921,1172,1792,4602,1049,8530,2592,1374,1580,2971,7023,1744],function(){return e(e.s=59918)}),_N_E=e.O()}]);