"use strict";exports.id=7711,exports.ids=[7711],exports.modules={37711:(e,a,t)=>{t.d(a,{M:()=>Z});var r=t(10326),s=t(17577),n=t(35047),o=t(34009),l=t(90434),i=t(5508),c=t(24061),d=t(49163),m=t(88378),h=t(79635),g=t(71810),u=t(69701);let x=()=>{let e=(0,n.usePathname)(),a=(0,u.e)(),[t,o]=(0,s.useState)(""),[x,f]=(0,s.useState)("");(0,s.useEffect)(()=>{document.cookie="force_manager_view=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="test_role=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="admin_redirected=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";let e=()=>{let e=document.querySelectorAll(".w-64.bg-gray-900");if(e.length>1){console.log("AdminSidebar: Found multiple sidebars, removing duplicates");for(let a=1;a<e.length;a++)e[a].remove()}document.querySelectorAll(".text-xl.font-bold").forEach(e=>{if(e.textContent?.includes("LegacyCore Manager")){let a=e.parentElement;for(;a&&!a.classList.contains("w-64");)a=a.parentElement;a&&(a.remove(),console.log("AdminSidebar: Removed manager sidebar"))}})};e(),setTimeout(e,100),setTimeout(e,500)},[]),(0,s.useEffect)(()=>{(async()=>{let{data:{session:e}}=await a.auth.getSession();e?.user&&(o(e.user.email||""),f(e.user.id||""))})()},[a]);let p=a=>e===a||e?.startsWith(a+"/"),b=async e=>{e.preventDefault(),await a.auth.signOut(),window.location.href="/login"};return(0,r.jsxs)("div",{className:"w-64 bg-gray-900 text-white flex flex-col h-screen",id:"admin-sidebar",children:[r.jsx("div",{className:"p-6 border-b border-slate-700",children:r.jsx("h1",{className:"text-xl font-bold",children:"LegacyCore Admin"})}),r.jsx("nav",{className:"flex-1 px-4 py-2",children:(0,r.jsxs)("ul",{className:"space-y-1",children:[r.jsx("li",{children:(0,r.jsxs)(l.default,{href:"/admin/dashboard",className:`flex items-center space-x-3 px-4 py-3 rounded-md ${p("/admin/dashboard")?"bg-slate-800 text-white":"text-slate-300 hover:bg-slate-800 hover:text-white"}`,children:[r.jsx(i.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"Dashboard"})]})}),r.jsx("li",{children:(0,r.jsxs)(l.default,{href:"/admin/views/user-management",className:`flex items-center space-x-3 px-4 py-3 rounded-md ${p("/admin/views/user-management")?"bg-slate-800 text-white":"text-slate-300 hover:bg-slate-800 hover:text-white"}`,children:[r.jsx(c.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"User Management"})]})}),r.jsx("li",{children:(0,r.jsxs)(l.default,{href:"/admin/views",className:`flex items-center space-x-3 px-4 py-3 rounded-md ${p("/admin/views")?"bg-slate-800 text-white":"text-slate-300 hover:bg-slate-800 hover:text-white"}`,children:[r.jsx(d.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"Role Views"})]})}),r.jsx("li",{children:(0,r.jsxs)(l.default,{href:"/admin/settings",className:`flex items-center space-x-3 px-4 py-3 rounded-md ${p("/admin/settings")?"bg-slate-800 text-white":"text-slate-300 hover:bg-slate-800 hover:text-white"}`,children:[r.jsx(m.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"Settings"})]})})]})}),(0,r.jsxs)("div",{className:"p-4 border-t border-slate-700",children:[(t||x)&&(0,r.jsxs)("div",{className:"px-4 py-2 mb-2 text-sm border-b border-slate-700 pb-2",children:[t&&(0,r.jsxs)("div",{className:"flex items-center space-x-3 text-slate-400 mb-1",children:[r.jsx(h.Z,{className:"h-4 w-4"}),r.jsx("span",{className:"truncate",children:t})]}),x&&r.jsx("div",{className:"text-xs text-slate-500 mt-1 pl-7",children:(0,r.jsxs)("span",{children:["ID: ",x]})})]}),(0,r.jsxs)("button",{onClick:b,className:"flex items-center space-x-3 w-full px-4 py-2 rounded-md text-slate-300 hover:bg-slate-800 hover:text-white",children:[r.jsx(g.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"Sign Out"})]})]})]})};var f=t(24319),p=t(48238),b=t(36283),w=t(59734),j=t(37358),v=t(40617),y=t(69508),N=t(46226);let S=()=>{let e=(0,n.usePathname)(),a=(0,u.e)(),[t,o]=(0,s.useState)(""),[l,d]=(0,s.useState)("");if((0,s.useEffect)(()=>{if(e?.startsWith("/admin")){console.log("ManagerSidebar: Prevented rendering on admin path");return}let a=()=>{let e=document.querySelectorAll(".w-64.bg-gray-900");e.length>1&&(console.log("ManagerSidebar: Found multiple sidebars, removing duplicates"),e.forEach(e=>{let a=e.querySelector(".text-xl.font-bold");a&&!a.textContent?.includes("LegacyCore Manager")&&e.remove()})),document.querySelectorAll(".text-xl.font-bold").forEach(e=>{if(e.textContent?.includes("LegacyCore Admin")){let a=e.parentElement;for(;a&&!a.classList.contains("w-64");)a=a.parentElement;a&&(a.remove(),console.log("ManagerSidebar: Removed admin sidebar"))}})};e?.startsWith("/manager")&&!document.cookie.includes("test_role=manager")&&(document.cookie="test_role=manager; path=/; max-age=86400"),a(),setTimeout(a,100),setTimeout(a,500)},[e]),(0,s.useEffect)(()=>{(async()=>{let{data:{session:e}}=await a.auth.getSession();e?.user&&(o(e.user.email||""),d(e.user.id||""))})()},[a]),e?.startsWith("/admin"))return console.log("ManagerSidebar: Prevented rendering on admin path to avoid double UI"),null;let h=a=>!!e&&(e===a||e===a+"/"||e.startsWith(a+"/")&&"/manager"!==a),x=async e=>{e.preventDefault(),console.log("Manager sidebar: initiating logout...");try{await a.auth.signOut(),console.log("Manager sidebar: signOut completed, redirecting..."),window.location.href="/login"}catch(e){console.error("Manager sidebar: logout error:",e),window.location.href="/login"}},S=[{href:"/manager/dashboard",label:"Dashboard",icon:r.jsx(f.Z,{className:"h-5 w-5"})},{href:"/manager/agents",label:"Agents",icon:r.jsx(c.Z,{className:"h-5 w-5"})},{href:"/manager/my-applications",label:"My Applications",icon:r.jsx(p.Z,{className:"h-5 w-5"})},{href:"/manager/applications",label:"All Applications",icon:r.jsx(b.Z,{className:"h-5 w-5"})},{href:"/manager/carriers",label:"Carriers",icon:r.jsx(w.Z,{className:"h-5 w-5"})},{href:"/manager/calendar",label:"Calendar",icon:r.jsx(j.Z,{className:"h-5 w-5"})},{href:"/manager/analytics",label:"Analytics",icon:r.jsx(i.Z,{className:"h-5 w-5"})},{href:"/manager/ai-chat",label:"AI Chat",icon:r.jsx(v.Z,{className:"h-5 w-5"})},{href:"/manager/script-assistant",label:"Script Assistant",icon:r.jsx(y.Z,{className:"h-5 w-5"})},{href:"/manager/settings",label:"Settings",icon:r.jsx(m.Z,{className:"h-5 w-5"})}],k=e=>{console.log(`Navigating to: ${e}`);let a=new URL(e,window.location.origin).toString(),t=new URL(a);t.searchParams.set("nocache",Date.now().toString()),window.location.href=t.toString()};return(0,r.jsxs)("div",{className:"w-64 bg-gradient-to-b from-gray-900 to-gray-800 text-white p-4 flex flex-col min-h-screen h-screen sticky top-0 left-0 shadow-lg",id:"manager-sidebar",children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsxs)("div",{className:"flex items-center mb-2",children:[r.jsx("div",{className:"w-10 h-10 mr-3 relative flex-shrink-0",children:r.jsx(N.default,{src:"/logo.png",alt:"LegacyCore Logo",width:40,height:40,className:"object-contain"})}),r.jsx("h1",{className:"text-xl font-bold text-white",children:"LegacyCore Manager"})]}),r.jsx("div",{className:"h-1 w-1/2 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full"})]}),r.jsx("nav",{className:"space-y-1.5 flex-1",children:S.map(e=>(0,r.jsxs)("button",{onClick:()=>k(e.href),className:`flex items-center space-x-3 p-2.5 rounded-lg w-full text-left transition-all duration-200 ${h(e.href)?"bg-gradient-to-r from-indigo-600/90 to-indigo-700/80 text-white shadow-md":"text-gray-300 hover:bg-gray-800/70 hover:text-white"}`,children:[e.icon,r.jsx("span",{className:"font-medium",children:e.label})]},e.href))}),r.jsx("div",{className:"flex-grow"}),t&&r.jsx("div",{className:"mt-4 py-3 border-t border-gray-700/50",children:(0,r.jsxs)("div",{className:"flex items-center",children:[r.jsx("div",{className:"w-9 h-9 rounded-full bg-indigo-600 flex items-center justify-center text-white shadow-md",children:t.charAt(0).toUpperCase()}),(0,r.jsxs)("div",{className:"ml-3 overflow-hidden",children:[r.jsx("p",{className:"text-sm font-medium truncate",children:t}),(0,r.jsxs)("button",{onClick:x,className:"flex items-center text-xs text-gray-400 hover:text-white transition-colors",children:[r.jsx(g.Z,{className:"h-3 w-3 mr-1"}),r.jsx("span",{children:"Sign out"})]})]})]})})]})};var k=t(71821),E=t(56418),C=t(5932),_=t(21405),R=t(6507),L=t(54751),T=t(50732),A=t(51996),U=t(74131);let $=()=>{let e=(0,n.usePathname)(),{signOut:a}=(0,U.a)(),[t,o]=(0,s.useState)(""),[i,c]=(0,s.useState)(""),[d,m]=(0,s.useState)({"/agent/attachments":!0}),x=(0,u.e)();(0,s.useEffect)(()=>{(async()=>{let{data:{session:e}}=await x.auth.getSession();e?.user&&(o(e.user.email||""),c(e.user.id||""))})()},[x]);let p=a=>e?.startsWith(a),y=e=>{m(a=>({...a,[e]:!a[e]}))},S=[{href:"/agent/dashboard",label:"Dashboard",icon:r.jsx(f.Z,{className:"h-5 w-5"})},{href:"/agent/script-assistant",label:"Script Assistant",icon:r.jsx(v.Z,{className:"h-5 w-5"})},{href:"/agent/applications",label:"My Applications",icon:r.jsx(b.Z,{className:"h-5 w-5"})},{href:"/agent/commissions",label:"Commissions",icon:r.jsx(k.Z,{className:"h-5 w-5"})},{href:"/agent/carriers",label:"Carriers",icon:r.jsx(w.Z,{className:"h-5 w-5"})},{href:"/agent/calendar",label:"Calendar",icon:r.jsx(j.Z,{className:"h-5 w-5"})}],$={href:"/agent/attachments",label:"Attachments",icon:r.jsx(E.Z,{className:"h-5 w-5"}),subItems:[{href:"/agent/attachments?type=email",label:"Email Processing",icon:r.jsx(C.Z,{className:"h-4 w-4"})},{href:"/agent/attachments?type=drafts",label:"Draft Returns",icon:r.jsx(_.Z,{className:"h-4 w-4"})},{href:"/agent/attachments?type=notifications",label:"Notifications",icon:r.jsx(R.Z,{className:"h-4 w-4"})},{href:"/agent/attachments?type=documents",label:"Documents",icon:r.jsx(L.Z,{className:"h-4 w-4"})}]},Z=[{href:"/agent/ai-chat",label:"AI Chat",icon:r.jsx(T.Z,{className:"h-5 w-5"})},{href:"/agent/applications/new",label:"New Application",icon:r.jsx(A.Z,{className:"h-5 w-5"})}];return(0,r.jsxs)("div",{className:"w-64 bg-gradient-to-b from-gray-900 to-gray-950 text-white p-4 flex flex-col min-h-screen h-full sticky top-0 left-0 shadow-lg",children:[r.jsx("div",{className:"mb-6 pt-2",children:(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[r.jsx("div",{className:"w-8 h-8 relative",children:r.jsx(N.default,{src:"/logo.png",alt:"LegacyCore Logo",width:32,height:32,className:"object-contain"})}),r.jsx("h1",{className:"text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-200 to-blue-400",children:"LegacyCore Agent"})]})}),(0,r.jsxs)("nav",{className:"space-y-1 flex-1",children:[r.jsx("div",{className:"pb-2",children:S.map(e=>(0,r.jsxs)(l.default,{href:e.href,className:`flex items-center space-x-2 p-2 rounded-md w-full text-left mb-1 transition-colors ${p(e.href)?"bg-gradient-to-r from-blue-800/60 to-blue-900/40 text-blue-200":"hover:bg-gray-800 text-gray-300 hover:text-white"}`,children:[r.jsx("div",{className:`${p(e.href)?"text-blue-400":"text-gray-400"}`,children:e.icon}),r.jsx("span",{children:e.label})]},e.href))}),(0,r.jsxs)("div",{className:"pb-2 border-t border-b border-gray-800 my-2 pt-2",children:[(0,r.jsxs)("button",{onClick:()=>y($.href),className:`flex items-center justify-between space-x-2 p-2 rounded-md w-full text-left mb-1 transition-colors ${p($.href)?"bg-gradient-to-r from-blue-800/60 to-blue-900/40 text-blue-200":"hover:bg-gray-800 text-gray-300 hover:text-white"}`,children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[r.jsx("div",{className:`${p($.href)?"text-blue-400":"text-gray-400"}`,children:$.icon}),r.jsx("span",{children:$.label})]}),r.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-4 w-4 transition-transform ${d[$.href]?"rotate-180":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d[$.href]&&r.jsx("div",{className:"ml-8 space-y-1 mt-1",children:$.subItems.map(a=>(0,r.jsxs)(l.default,{href:a.href,className:`flex items-center space-x-2 p-1.5 rounded-md w-full text-left text-sm transition-colors ${p(a.href)&&e?.includes(new URL(a.href,"http://example.com").search)?"bg-blue-900/30 text-blue-300":"hover:bg-gray-800/50 text-gray-400 hover:text-white"}`,children:[r.jsx("div",{className:`${p(a.href)&&e?.includes(new URL(a.href,"http://example.com").search)?"text-blue-400":"text-gray-500"}`,children:a.icon}),r.jsx("span",{children:a.label})]},a.href))})]}),r.jsx("div",{className:"pb-2",children:Z.map(e=>(0,r.jsxs)(l.default,{href:e.href,className:`flex items-center space-x-2 p-2 rounded-md w-full text-left mb-1 transition-colors ${p(e.href)?"bg-gradient-to-r from-blue-800/60 to-blue-900/40 text-blue-200":"hover:bg-gray-800 text-gray-300 hover:text-white"}`,children:[r.jsx("div",{className:`${p(e.href)?"text-blue-400":"text-gray-400"}`,children:e.icon}),r.jsx("span",{children:e.label})]},e.href))})]}),r.jsx("div",{className:"flex-grow"}),(t||i)&&r.jsx("div",{className:"p-3 mb-2 rounded-lg bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-800 shadow-inner",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-blue-700 p-2 rounded-full",children:r.jsx(h.Z,{className:"h-4 w-4 text-blue-100"})}),(0,r.jsxs)("div",{className:"flex flex-col",children:[r.jsx("span",{className:"text-xs text-gray-400 mb-0.5",children:"Logged in as:"}),r.jsx("span",{className:"text-xs text-gray-200 break-all leading-snug font-medium",children:t}),i&&(0,r.jsxs)("span",{className:"text-xs text-gray-400 break-all leading-snug mt-1 bg-gray-900/50 p-1.5 rounded border border-gray-800 mt-2 font-mono",children:["ID: ",i]})]})]})}),(0,r.jsxs)("button",{onClick:()=>a(),className:"flex items-center justify-center space-x-2 p-2 rounded-md bg-gradient-to-r from-gray-800 to-gray-700 hover:from-red-900 hover:to-red-800 text-gray-300 hover:text-white w-full text-center transition-colors duration-300",children:[r.jsx(g.Z,{className:"h-4 w-4 flex-shrink-0"}),r.jsx("span",{children:"Logout"})]})]})},Z=({children:e})=>{let{role:a,loading:t}=(0,o.q)(),l=(0,n.usePathname)(),i=(0,n.useRouter)(),[c,d]=(0,s.useState)(!0),[m,h]=(0,s.useState)(!0);return(0,s.useEffect)(()=>{console.log("RoleBasedLayout: Current role =",a),console.log("RoleBasedLayout: Current path =",l)},[a,l]),(0,s.useEffect)(()=>{let e=setTimeout(()=>{h(!1);let e=document.querySelectorAll(".loading-indicator");e.length>0&&(console.log("RoleBasedLayout: Found loading indicators that might be stuck, removing them"),e.forEach(e=>e.remove()))},2e3);return()=>clearTimeout(e)},[]),(0,s.useEffect)(()=>{t?d(!1):d(!0)},[t]),(0,s.useEffect)(()=>{if(!a||!l)return;let e=l.startsWith("/admin"),t=l.startsWith("/manager"),r=l.startsWith("/agent");a&&l&&(()=>{if("admin"===a&&!e){i.push("/admin/dashboard");return}if("manager"===a&&!t){e&&console.log("⚠️ Path mismatch: User with role manager on admin path. Redirecting..."),i.push("/manager/dashboard");return}if("agent"===a&&!r){(e||t)&&console.log("⚠️ Path mismatch: User with role agent on admin/manager path. Redirecting..."),i.push("/agent/dashboard");return}})()},[a,l,i]),(0,s.useEffect)(()=>{if(l?.startsWith("/agent")){let e=document.cookie.split("; ").find(e=>e.startsWith("test_role="))?.split("=")[1];e&&"agent"!==e&&(console.log(`Detected conflicting test_role=${e} cookie on agent path, clearing it`),document.cookie="test_role=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="force_manager_view=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="admin_redirected=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT")}},[l]),(0,r.jsxs)("div",{className:"flex flex-row min-h-screen bg-gray-100 w-full overflow-hidden",children:[(()=>{if(t)return console.log("RoleBasedLayout: Still loading, not showing sidebar yet"),null;if(l){if(l.startsWith("/agent"))return console.log("RoleBasedLayout: On agent path, showing AgentSidebar"),r.jsx($,{});if(l.startsWith("/manager"))return console.log("RoleBasedLayout: On manager path, showing ManagerSidebar"),r.jsx(S,{});if(l.startsWith("/admin"))return console.log("RoleBasedLayout: On admin path, showing AdminSidebar"),r.jsx(x,{})}return"admin"===a?(console.log("RoleBasedLayout: Using role-based AdminSidebar"),r.jsx(x,{})):"manager"===a?(console.log("RoleBasedLayout: Using role-based ManagerSidebar"),r.jsx(S,{})):"agent"===a?(console.log("RoleBasedLayout: Using role-based AgentSidebar"),r.jsx($,{})):(console.log("RoleBasedLayout: No matching sidebar for role:",a),null)})(),r.jsx("div",{className:"flex-1 overflow-hidden min-h-screen h-screen max-h-screen",children:m&&!c?r.jsx("div",{className:"loading-indicator flex justify-center items-center h-screen",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):c&&r.jsx("main",{className:"p-4 h-full overflow-y-auto overflow-x-hidden",children:e})})]})}},34009:(e,a,t)=>{t.d(a,{q:()=>n});var r=t(17577),s=t(69701);let n=()=>{let[e,a]=(0,r.useState)(null),[t,n]=(0,r.useState)(!0),[o,l]=(0,r.useState)(!1),[i,c]=(0,r.useState)(0),d=(0,s.e)(),m=()=>{console.log("Clearing all role-related cookies to prevent conflicts"),document.cookie="force_manager_view=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="test_role=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="admin_redirected=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="handling_redirect=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT"},h=async(e,a)=>{console.log("⚠️ SECURITY: Forcing removal of admin role for unauthorized user"),m();try{await d.from("profiles").update({role:"agent"}).eq("id",e),console.log("Updated database role from admin to agent");let{error:a}=await d.auth.updateUser({data:{role:"agent"}});a&&console.error("Error updating user metadata:",a),setTimeout(()=>window.location.href="/agent/dashboard",100)}catch(e){console.error("Error clearing admin role:",e)}},g=async(e,a)=>{try{console.log(`Synchronizing user metadata role to match database: ${a}`);let{error:e}=await d.auth.updateUser({data:{role:a}});e&&console.error("Error updating user metadata:",e)}catch(e){console.error("Error synchronizing roles:",e)}},u=e=>{let a=Date.now();if(o||a-i<2e3){console.log("Preventing potential redirect loop");return}l(!0),c(a),document.cookie="handling_redirect=true; path=/; max-age=5",setTimeout(()=>{console.log(`Redirecting to /${e}/dashboard`),window.location.href=`/${e}/dashboard`,l(!1)},100)};return(0,r.useEffect)(()=>{let e=async()=>{try{let e=window.location.pathname,s=e.startsWith("/admin"),o=e.startsWith("/manager"),l=e.startsWith("/agent");if(s||o||l){let e=document.cookie.split("; ").find(e=>e.startsWith("test_role="))?.split("=")[1];l&&e&&"agent"!==e&&(console.log(`Path is /agent but test_role cookie is ${e}, clearing to prevent sidebar mismatch`),m()),o&&e&&"manager"!==e&&(console.log(`Path is /manager but test_role cookie is ${e}, clearing to prevent sidebar mismatch`),m()),s&&e&&"admin"!==e&&(console.log(`Path is /admin but test_role cookie is ${e}, clearing to prevent sidebar mismatch`),m())}if(document.cookie.includes("handling_redirect=true")){console.log("Skipping role check - redirect in progress"),n(!1);return}let i=document.cookie.split("; ").find(e=>e.startsWith("force_manager_view="))?.split("=")[1],c=document.cookie.split("; ").find(e=>e.startsWith("test_role="))?.split("=")[1],{data:{session:x}}=await d.auth.getSession();if(!x){a(null),n(!1);return}let f=["980ebab6-9e1a-4c53-876a-978c8c640f7e","adbdb861-5ce8-4b5c-af50-7deb93a687c1"];if(x.user.user_metadata?.role==="admin"&&!f.includes(x.user.id)){await h(x.user.id,x.user.email||""),a("agent"),n(!1);return}if("true"===i){console.log("⚠️ FORCED MANAGER VIEW: Using manager role from force_manager_view cookie"),await r(x.user.id,x.user.email,"manager"),a("manager"),n(!1);return}if(l){console.log("\uD83D\uDC49 On agent path, ensuring agent role and sidebar"),c&&m(),a("agent"),n(!1);return}if(o){console.log("\uD83D\uDC49 On manager path, ensuring manager role and sidebar"),c&&m(),a("manager"),n(!1);return}if(s){if(f.includes(x.user.id)){console.log("\uD83D\uDC49 On admin path with valid admin ID, ensuring admin role and sidebar"),c&&m(),a("admin"),n(!1);return}console.log("⚠️ SECURITY: Non-admin attempting to access admin path"),m(),u("agent");return}if("56e8e969-76fd-4d69-a8ca-3e315487c2c4"===x.user.id){console.log("⚠️ APPLYING ROLE OVERRIDE: Setting role to manager for santosUser"),await r(x.user.id,x.user.email,"manager"),a("manager"),n(!1);return}if(c&&["admin","manager","agent"].includes(c)){if("admin"===c&&!f.includes(x.user.id)){console.log("⚠️ SECURITY: Unauthorized admin access attempt via cookie. Defaulting to agent role."),document.cookie="test_role=agent; path=/; max-age=86400",a("agent"),n(!1);return}console.log(`⚠️ DEVELOPMENT MODE: Using ${c} role from test_role cookie`),a(c),n(!1);return}let{data:p}=await d.from("profiles").select("role").eq("id",x.user.id).single();if(p&&p.role){if(console.log(`Using role from database profile: ${p.role}`),"admin"===p.role&&!f.includes(x.user.id)){console.warn("⚠️ SECURITY: Unauthorized admin role in database. Correcting to agent."),await h(x.user.id,x.user.email||""),a("agent"),n(!1);return}if(x.user.user_metadata?.role&&x.user.user_metadata.role!==p.role&&(console.warn(`⚠️ Role mismatch: metadata (${x.user.user_metadata.role}) vs database (${p.role}). Using database role.`),await g(x.user.id,p.role)),a(p.role),e.startsWith("/admin")&&"admin"!==p.role){console.log(`⚠️ Path mismatch: User with role ${p.role} on admin path. Redirecting...`),n(!1),u(p.role);return}if(e.startsWith("/manager")&&"manager"!==p.role){console.log(`⚠️ Path mismatch: User with role ${p.role} on manager path. Redirecting...`),n(!1),u(p.role);return}if(e.startsWith("/agent")&&"agent"!==p.role){console.log(`⚠️ Path mismatch: User with role ${p.role} on agent path. Redirecting...`),n(!1),u(p.role);return}n(!1);return}if(x.user.user_metadata?.role&&["admin","manager","agent"].includes(x.user.user_metadata.role)){if("admin"===x.user.user_metadata.role&&!f.includes(x.user.id)){console.warn("⚠️ SECURITY: Unauthorized admin role in metadata. Correcting to agent."),await h(x.user.id,x.user.email||""),a("agent"),n(!1);return}console.log(`Using role from user metadata (no profile): ${x.user.user_metadata.role}`),await t(x.user.id,x.user.email,x.user.user_metadata.role),a(x.user.user_metadata.role)}else console.log("No role found. Defaulting to agent role."),await t(x.user.id,x.user.email||"","agent"),a("agent");n(!1)}catch(e){console.error("Error determining user role:",e),a(null),n(!1)}},t=async(e,a,t)=>{try{let{error:r}=await d.from("profiles").insert({id:e,email:a,role:t}).select();r&&console.error("Error creating user profile:",r)}catch(e){console.error("Error in profile creation:",e)}},r=async(e,a,r)=>{try{let{data:s}=await d.from("profiles").select("role").eq("id",e).single();s?s.role!==r&&(await d.from("profiles").update({role:r}).eq("id",e),console.log(`Updated profile role from ${s.role} to ${r}`)):(await t(e,a,r),console.log(`Created new profile with role ${r}`))}catch(e){console.error("Error ensuring profile has role:",e)}};e();let{data:{subscription:s}}=d.auth.onAuthStateChange((t,r)=>{if(!r){a(null);return}e()});return()=>{s.unsubscribe()}},[d,o,i]),{role:e,loading:t,isAdmin:"admin"===e,isManager:"manager"===e,isAgent:"agent"===e}}}};